From ec2f39eebd444dfcc6bd6c0c75cd8d404dacf4c7 Mon Sep 17 00:00:00 2001
Date: Wed, 6 Aug 2025 13:57:40 +0530
Subject: [PATCH] [PATCH] Fixed memory leak when entering StreamImage multiple
 times.

---
 magick/stream.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/magick/stream.c b/magick/stream.c
index a44b550..ea6ddd9 100644
--- a/magick/stream.c
+++ b/magick/stream.c
@@ -1275,7 +1275,8 @@ MagickExport Image *StreamImage(const ImageInfo *image_info,
   assert(exception != (ExceptionInfo *) NULL);
   read_info=CloneImageInfo(image_info);
   stream_info->image_info=image_info;
-  stream_info->quantum_info=AcquireQuantumInfo(image_info,(Image *) NULL);
+  if (stream_info->quantum_info == (QuantumInfo *) NULL)
+    stream_info->quantum_info=AcquireQuantumInfo(image_info,(Image *) NULL);
   if (stream_info->quantum_info == (QuantumInfo *) NULL)
     {
       read_info=DestroyImageInfo(read_info);
-- 
2.43.0

From d636104ff9a89c84f9334a9f1370f2eacb3d115c Mon Sep 17 00:00:00 2001
Date: Wed, 6 Aug 2025 06:39:26 +0000
Subject: [PATCH] patch

---
 magick/image.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: imagemagick-6.9.11.60+dfsg/magick/image.c
===================================================================
--- imagemagick-6.9.11.60+dfsg.orig/magick/image.c
+++ imagemagick-6.9.11.60+dfsg/magick/image.c
@@ -1682,7 +1682,7 @@ MagickExport size_t InterpretImageFilena
     q=(char *) p+1;
     if (*q == '%')
       {
-        p=q+1;
+        p++;
         continue;
       }
     field_width=0;diff --git a/magick/image.c b/magick/image.c
index 1fc3617..ee96ac6 100644
--- a/magick/image.c
+++ b/magick/image.c
@@ -1671,7 +1671,6 @@ MagickExport size_t InterpretImageFilename(const ImageInfo *image_info,
     *p;
 
   ssize_t
-    field_width,
     offset;
 
   canonical=MagickFalse;
@@ -1685,21 +1684,22 @@ MagickExport size_t InterpretImageFilename(const ImageInfo *image_info,
         p=q+1;
         continue;
       }
-    field_width=0;
-    if (*q == '0')
-      field_width=(ssize_t) strtol(q,&q,10);
     switch (*q)
     {
       case 'd':
       case 'o':
       case 'x':
       {
+        ssize_t
+          count;
         q++;
         c=(*q);
         *q='\0';
-        (void) FormatLocaleString(filename+(p-format-offset),(size_t)
+        count=FormatLocaleString(filename+(p-format-offset),(size_t)
           (MaxTextExtent-(p-format-offset)),p,value);
-        offset+=(4-field_width);
+        if ((count <= 0) || (count > (MagickPathExtent-(p-format-offset))))
+          return(0);
+        offset+=(ssize_t) ((q-p)-count);
         *q=c;
         (void) ConcatenateMagickString(filename,q,MaxTextExtent);
         canonical=MagickTrue;
