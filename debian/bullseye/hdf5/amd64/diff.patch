From 0a7f89d5ad984d49ca64be9c773143eceaf49b77 Mon Sep 17 00:00:00 2001
From: abushwang <31229623+wswsmao@users.noreply.github.com>
Date: Wed, 4 Sep 2024 00:11:07 +0800
Subject: [PATCH] Fix CVE-2022-25942: Add bounds checking to avoid Out-of-bounds Write for gif2h5

Backported to hdf5_1_10_8

This fix adds bounds checking in the Decompress function to prevent
out-of-bounds array access when processing specially-crafted GIF files.
The vulnerability could lead to code execution via buffer overflow.

The fix checks if FreeCode exceeds the array bounds (4096) before
accessing the Prefix and Suffix arrays.

---
 hl/tools/gif2h5/decompress.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/hl/tools/gif2h5/decompress.c b/hl/tools/gif2h5/decompress.c
index e87a60cf7a..62a22922ff 100644
--- a/hl/tools/gif2h5/decompress.c
+++ b/hl/tools/gif2h5/decompress.c
@@ -296,6 +296,10 @@ Decompress(GIFIMAGEDESC *GifImageDesc, GIFHEAD *GifHead)
              * Build the hash table on-the-fly. No table is stored in the
              * file.
              */
+            if (FreeCode >= 4096) {
+                printf("Error: FreeCode out of bounds\n");
+                exit(EXIT_FAILURE);
+            }
             Prefix[FreeCode] = OldCode;
             Suffix[FreeCode] = FinChar;
             OldCode          = InCode;
-- 
2.45.2 